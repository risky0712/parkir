<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Parkir Barcode</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100">
<div class="max-w-md mx-auto p-4">

<h1 class="text-xl font-bold text-center mb-4">ðŸš— Parkir Barcode</h1>

<div class="grid grid-cols-2 gap-3 mb-4">
  <button onclick="showMasuk()" class="bg-green-600 text-white py-3 rounded-xl">Masuk</button>
  <button onclick="showKeluar()" class="bg-red-600 text-white py-3 rounded-xl">Keluar</button>
</div>

<!-- SCANNER -->
<div id="scannerBox" class="hidden bg-black rounded-xl mb-3 overflow-hidden">
  <video id="video" class="w-full h-56 object-cover"></video>
</div>

<!-- MASUK -->
<div id="masuk" class="bg-white p-4 rounded-xl hidden">
  <p class="text-center mb-2 text-gray-600">Scan QR Kendaraan</p>

  <input id="nomorMasuk" class="w-full border p-3 rounded mb-3" readonly>

  <!-- FOTO -->
  <input
    type="file"
    accept="image/*"
    capture="environment"
    id="fotoInput"
    class="mb-3 w-full"
  >
</div>

<!-- KELUAR -->
<div id="keluar" class="bg-white p-4 rounded-xl hidden">
  <p class="text-center mb-2 text-gray-600">Scan QR Kendaraan</p>

  <input id="nomorKeluar" class="w-full border p-3 rounded mb-3" readonly>

  <img id="fotoKeluar" class="hidden rounded mb-3">

  <button id="btnKeluar" onclick="prosesKeluar()" class="hidden w-full bg-red-600 text-white py-3 rounded-xl">
    Kendaraan Keluar
  </button>
</div>

</div>

<script>
/* ================= CONFIG ================= */
const GAS_URL = "https://script.google.com/macros/s/AKfycbxZ2xlzIL84ucdHBQ9nsOQ8eLf3c5cONbx8CjiALFb8RodhPjdGU26mRRDwchSDHCYe/exec";
let videoStream, scanMode;

/* ================= BARCODE ================= */
const detector = 'BarcodeDetector' in window
  ? new BarcodeDetector({ formats:['qr_code','code_128'] })
  : null;

/* ================= UI ================= */
function showMasuk(){
  masuk.classList.remove('hidden');
  keluar.classList.add('hidden');
  startScan('masuk');
}

function showKeluar(){
  keluar.classList.remove('hidden');
  masuk.classList.add('hidden');
  startScan('keluar');
}

/* ================= SCAN ================= */
async function startScan(mode){
  scanMode = mode;
  scannerBox.classList.remove('hidden');

  videoStream = await navigator.mediaDevices.getUserMedia({
    video:{ facingMode:'environment' }
  });

  video.srcObject = videoStream;
  video.play();
  scanLoop();
}

async function scanLoop(){
  if(video.readyState === video.HAVE_ENOUGH_DATA){
    const codes = await detector.detect(video);
    if(codes.length){
      stopScan();

      const kode = codes[0].rawValue;

      if(scanMode === 'masuk'){
        nomorMasuk.value = kode;

        // ðŸ”¥ INI INTI PERUBAHANNYA
        setTimeout(()=> fotoInput.click(), 300);

      }else{
        nomorKeluar.value = kode;
        cekKeluar();
      }
      return;
    }
  }
  requestAnimationFrame(scanLoop);
}

function stopScan(){
  scannerBox.classList.add('hidden');
  if(videoStream) videoStream.getTracks().forEach(t=>t.stop());
}

/* ================= SIMPAN MASUK ================= */
fotoInput.addEventListener("change", ()=>{
  if(!fotoInput.files[0] || !nomorMasuk.value) return;

  const reader = new FileReader();
  reader.onload = async e =>{
    const data = {
      nomor: nomorMasuk.value,
      foto: e.target.result,
      waktu: Date.now(),
      status: "PARKIR"
    };

    localStorage.setItem("parkir_" + data.nomor, JSON.stringify(data));

    await fetch(GAS_URL,{
      method:"POST",
      body: JSON.stringify(data)
    });

    nomorMasuk.value = "";
    fotoInput.value = "";
    alert("Parkir masuk berhasil");
  };
  reader.readAsDataURL(fotoInput.files[0]);
});

/* ================= CEK KELUAR ================= */
async function cekKeluar(){
  const nomor = nomorKeluar.value;
  let data = JSON.parse(localStorage.getItem("parkir_" + nomor) || "null");

  if(!data){
    const res = await fetch(GAS_URL);
    const server = await res.json();
    data = server.find(d=>d.nomor===nomor && d.status==="PARKIR");
  }

  if(!data) return alert("Data tidak ditemukan");

  fotoKeluar.src = data.foto;
  fotoKeluar.classList.remove('hidden');
  btnKeluar.classList.remove('hidden');
}

/* ================= PROSES KELUAR ================= */
async function prosesKeluar(){
  const key = "parkir_" + nomorKeluar.value;
  let d = JSON.parse(localStorage.getItem(key));

  d.status = "KELUAR";
  d.waktu = Date.now();

  await fetch(GAS_URL,{
    method:"POST",
    body: JSON.stringify(d)
  });

  localStorage.removeItem(key);

  fotoKeluar.classList.add('hidden');
  btnKeluar.classList.add('hidden');
  nomorKeluar.value = "";
  alert("Kendaraan keluar");
}
</script>

</body>
</html>
