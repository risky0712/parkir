<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Parkir Barcode</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100">
<div class="max-w-md mx-auto p-4">

<h1 class="text-xl font-bold text-center mb-4">ðŸš— Parkir Barcode</h1>

<div class="grid grid-cols-2 gap-3 mb-4">
  <button onclick="showMasuk()" class="bg-green-600 text-white py-3 rounded-xl">Masuk</button>
  <button onclick="showKeluar()" class="bg-red-600 text-white py-3 rounded-xl">Keluar</button>
</div>

<!-- SCANNER -->
<div id="scannerBox" class="hidden bg-black rounded-xl mb-3 overflow-hidden">
  <video id="video" class="w-full h-56 object-cover"></video>
</div>

<!-- MASUK -->
<div id="masuk" class="bg-white p-4 rounded-xl hidden">
  <p class="text-center mb-2 text-gray-600">Scan QR Kendaraan</p>
  <input id="nomorMasuk" class="w-full border p-3 rounded mb-3" readonly>

  <!-- FOTO (AUTO) -->
  <input
    type="file"
    accept="image/*"
    capture="environment"
    id="fotoInput"
    class="hidden"
  >

  <p id="hintFoto" class="text-center text-sm text-gray-500 hidden">
    Mengambil foto kendaraan...
  </p>
</div>

<!-- KELUAR -->
<div id="keluar" class="bg-white p-4 rounded-xl hidden">
  <p class="text-center mb-2 text-gray-600">Scan QR Kendaraan</p>
  <input id="nomorKeluar" class="w-full border p-3 rounded mb-3" readonly>

  <img id="fotoKeluar" class="hidden rounded mb-3">

  <button id="btnKeluar" onclick="prosesKeluar()" class="hidden w-full bg-red-600 text-white py-3 rounded-xl">
    Kendaraan Keluar
  </button>
</div>

</div>

<script>
/* ================= CONFIG ================= */
const GAS_URL = "https://script.google.com/macros/s/AKfycbxZ2xlzIL84ucdHBQ9nsOQ8eLf3c5cONbx8CjiALFb8RodhPjdGU26mRRDwchSDHCYe/exec";
let videoStream, scanMode, syncing = false;

/* ================= BARCODE ================= */
const detector = 'BarcodeDetector' in window
  ? new BarcodeDetector({ formats:['qr_code','code_128'] })
  : null;

/* ================= UI ================= */
function showMasuk(){
  masuk.classList.remove('hidden');
  keluar.classList.add('hidden');
  startScan('masuk');
}

function showKeluar(){
  keluar.classList.remove('hidden');
  masuk.classList.add('hidden');
  startScan('keluar');
}

/* ================= SCAN ================= */
async function startScan(mode){
  scanMode = mode;
  scannerBox.classList.remove('hidden');

  videoStream = await navigator.mediaDevices.getUserMedia({
    video:{ facingMode:'environment' }
  });

  video.srcObject = videoStream;
  video.play();
  scanLoop();
}

async function scanLoop(){
  if(video.readyState === video.HAVE_ENOUGH_DATA){
    const codes = await detector.detect(video);
    if(codes.length){
      stopScan();
      const kode = codes[0].rawValue;

      if(scanMode === 'masuk'){
        nomorMasuk.value = kode;
        autoAmbilFoto();   // ðŸ”¥ AUTO KE FOTO
      } else {
        nomorKeluar.value = kode;
        cekKeluar();
      }
      return;
    }
  }
  requestAnimationFrame(scanLoop);
}

function stopScan(){
  scannerBox.classList.add('hidden');
  if(videoStream) videoStream.getTracks().forEach(t=>t.stop());
}

/* ================= AUTO FOTO & SIMPAN ================= */
function autoAmbilFoto(){
  hintFoto.classList.remove('hidden');
  fotoInput.click();
}

fotoInput.addEventListener("change", ()=>{
  if(!fotoInput.files[0]) return;

  const reader = new FileReader();
  reader.onload = e =>{
    const data = {
      nomor: nomorMasuk.value,
      foto: e.target.result,
      waktu: Date.now(),
      status: "PARKIR",
      synced: false
    };

    localStorage.setItem("parkir_" + data.nomor, JSON.stringify(data));
    hintFoto.classList.add('hidden');
    nomorMasuk.value = "";
    fotoInput.value = "";

    backgroundSync(); // ðŸš€ langsung sync
    alert("Parkir masuk berhasil");
  };
  reader.readAsDataURL(fotoInput.files[0]);
});

/* ================= CEK KELUAR ================= */
async function cekKeluar(){
  const nomor = nomorKeluar.value;
  let data = JSON.parse(localStorage.getItem("parkir_" + nomor) || "null");

  if(!data && navigator.onLine){
    const res = await fetch(GAS_URL);
    const server = await res.json();
    data = server.find(d=>d.nomor===nomor && d.status==="PARKIR");
  }

  if(!data) return alert("Data tidak ditemukan");

  fotoKeluar.src = data.foto;
  fotoKeluar.classList.remove('hidden');
  btnKeluar.classList.remove('hidden');
}

/* ================= PROSES KELUAR ================= */
function prosesKeluar(){
  const key = "parkir_" + nomorKeluar.value;
  let d = JSON.parse(localStorage.getItem(key));

  d.status = "KELUAR";
  d.waktu = Date.now();
  d.synced = false;

  localStorage.setItem(key, JSON.stringify(d));
  backgroundSync();

  setTimeout(()=>localStorage.removeItem(key), 1500);

  fotoKeluar.classList.add('hidden');
  btnKeluar.classList.add('hidden');
  nomorKeluar.value = "";
  alert("Kendaraan keluar");
}

/* ================= SYNC KE SPREADSHEET ================= */
async function backgroundSync(){
  if(syncing || !navigator.onLine) return;
  syncing = true;

  for(const k of Object.keys(localStorage)){
    if(!k.startsWith("parkir_")) continue;
    const d = JSON.parse(localStorage.getItem(k));
    if(d.synced) continue;

    try{
      await fetch(GAS_URL,{
        method:"POST",
        body: JSON.stringify(d)
      });
      d.synced = true;
      localStorage.setItem(k, JSON.stringify(d));
    }catch{}
  }
  syncing = false;
}

/* ================= AUTO BACKGROUND ================= */
setInterval(backgroundSync, 10000);
window.addEventListener("online", backgroundSync);
</script>
</body>
</html>
