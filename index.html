<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Parkir Barcode</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100">

<div class="max-w-md mx-auto p-4">
<h1 class="text-xl font-bold text-center mb-4">ðŸš— Parkir Barcode</h1>

<div class="grid grid-cols-2 gap-3 mb-4">
  <button onclick="showMasuk()" class="bg-green-600 text-white py-3 rounded-xl">Masuk</button>
  <button onclick="showKeluar()" class="bg-red-600 text-white py-3 rounded-xl">Keluar</button>
</div>

<!-- SCANNER -->
<div id="scannerBox" class="hidden bg-black rounded-xl mb-3 overflow-hidden">
  <video id="video" class="w-full h-56 object-cover"></video>
</div>

<!-- MASUK -->
<div id="masuk" class="bg-white p-4 rounded-xl hidden">
  <button onclick="startScan('masuk')" class="w-full bg-blue-600 text-white py-2 rounded mb-3">
    Scan Barcode
  </button>
  <input id="nomorMasuk" class="w-full border p-3 rounded mb-3" readonly>
  <input type="file" accept="image/*" capture="environment" id="fotoInput" class="mb-3 w-full">
  <button onclick="simpanMasuk()" class="w-full bg-green-600 text-white py-3 rounded-xl">
    Simpan
  </button>
</div>

<!-- KELUAR -->
<div id="keluar" class="bg-white p-4 rounded-xl hidden">
  <button onclick="startScan('keluar')" class="w-full bg-blue-600 text-white py-2 rounded mb-3">
    Scan Barcode
  </button>
  <input id="nomorKeluar" class="w-full border p-3 rounded mb-3" readonly>
  <img id="fotoKeluar" class="hidden rounded mb-3">
  <button id="btnKeluar" onclick="prosesKeluar()" class="hidden w-full bg-red-600 text-white py-3 rounded-xl">
    Kendaraan Keluar
  </button>
</div>
</div>

<script>
/* ================= CONFIG ================= */
const GAS_URL = "https://script.google.com/macros/s/AKfycbxZ2xlzIL84ucdHBQ9nsOQ8eLf3c5cONbx8CjiALFb8RodhPjdGU26mRRDwchSDHCYe/exec";
let videoStream, scanMode, syncing = false;

/* ================= BARCODE ================= */
const detector = 'BarcodeDetector' in window
  ? new BarcodeDetector({ formats:['qr_code','code_128'] })
  : null;

/* ================= UI ================= */
function showMasuk(){ masuk.classList.remove('hidden'); keluar.classList.add('hidden'); }
function showKeluar(){ keluar.classList.remove('hidden'); masuk.classList.add('hidden'); }

/* ================= SCAN ================= */
async function startScan(mode){
  scanMode = mode;
  scannerBox.classList.remove('hidden');
  videoStream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' }});
  video.srcObject = videoStream;
  video.play();
  scanLoop();
}

async function scanLoop(){
  if(video.readyState === video.HAVE_ENOUGH_DATA){
    const codes = await detector.detect(video);
    if(codes.length){
      stopScan();
      const kode = codes[0].rawValue;
      if(scanMode === 'masuk') nomorMasuk.value = kode;
      else { nomorKeluar.value = kode; cekKeluar(); }
      return;
    }
  }
  requestAnimationFrame(scanLoop);
}

function stopScan(){
  scannerBox.classList.add('hidden');
  if(videoStream) videoStream.getTracks().forEach(t => t.stop());
}

/* ================= MASUK ================= */
function simpanMasuk(){
  if(!nomorMasuk.value || !fotoInput.files[0]) return alert("Lengkapi data");

  const reader = new FileReader();
  reader.onload = e => {
    localStorage.setItem("parkir_" + nomorMasuk.value, JSON.stringify({
      nomor: nomorMasuk.value,
      foto: e.target.result,
      waktuMasuk: Date.now(),
      status: "PARKIR",
      synced: false
    }));
    nomorMasuk.value = "";
    fotoInput.value = "";
    alert("Parkir masuk tersimpan");
  };
  reader.readAsDataURL(fotoInput.files[0]);
}

/* ================= CEK KELUAR (LOCAL â†’ SHEET) ================= */
async function cekKeluar(){
  const nomor = nomorKeluar.value;
  let data = JSON.parse(localStorage.getItem("parkir_" + nomor) || "null");

  // jika tidak ada di local, ambil dari spreadsheet
  if(!data && navigator.onLine){
    try{
      const res = await fetch(GAS_URL);
      const server = await res.json();
      data = server.find(d => d.nomor === nomor && d.status === "PARKIR");
    }catch{}
  }

  if(!data) return alert("Data tidak ditemukan");

  fotoKeluar.src = data.foto;
  fotoKeluar.classList.remove('hidden');
  btnKeluar.classList.remove('hidden');
}

/* ================= PROSES KELUAR ================= */
function prosesKeluar(){
  const key = "parkir_" + nomorKeluar.value;
  let d = JSON.parse(localStorage.getItem(key) || "{}");

  d.status = "KELUAR";
  d.waktuKeluar = Date.now();
  d.synced = false;

  localStorage.setItem(key, JSON.stringify(d));

  // hapus lokal SETELAH ditandai keluar
  setTimeout(() => localStorage.removeItem(key), 1000);

  alert("Kendaraan keluar");
  fotoKeluar.classList.add('hidden');
  btnKeluar.classList.add('hidden');
  nomorKeluar.value = "";
}

/* ================= SYNC KE SPREADSHEET ================= */
async function backgroundSync(){
  if(syncing || !navigator.onLine) return;
  syncing = true;

  for(const k of Object.keys(localStorage)){
    if(!k.startsWith("parkir_")) continue;
    const d = JSON.parse(localStorage.getItem(k));
    if(d.synced) continue;

    try{
      await fetch(GAS_URL,{
        method:"POST",
        body: JSON.stringify(d)
      });
      d.synced = true;
      localStorage.setItem(k, JSON.stringify(d));
    }catch{}
  }
  syncing = false;
}

/* ================= SYNC DARI SPREADSHEET ================= */
async function syncFromSpreadsheet(){
  if(!navigator.onLine) return;

  try{
    const res = await fetch(GAS_URL);
    const serverData = await res.json();

    serverData.forEach(d=>{
      const key = "parkir_" + d.nomor;

      if(d.status === "PARKIR" && !localStorage.getItem(key)){
        localStorage.setItem(key, JSON.stringify({
          nomor: d.nomor,
          foto: d.foto,
          waktuMasuk: new Date(d.waktu).getTime(),
          status: "PARKIR",
          synced: true
        }));
      }

      if(d.status === "KELUAR"){
        localStorage.removeItem(key);
      }
    });

  }catch{}
}

/* ================= AUTO BACKGROUND ================= */
setInterval(backgroundSync, 10000);
setInterval(syncFromSpreadsheet, 10000);
window.addEventListener("online", backgroundSync);
</script>

</body>
</html>
